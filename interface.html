<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
    //var Chess = require('./chess').Chess;
    var chess = new Chess();
    
    function init() {
      render(chess);
    }
    
    function parseMove(moveString) {
        /* Check for from to */
        for (let move of chess.moves({ verbose: true })) {
            if (moveString.indexOf(move.from) !== -1 && moveString.indexOf(move.to) !== -1) {
                return move;
            }
        }
        /* Check for exact Forsyth-Edwards notation */
        for (let move of chess.moves()) {
            if (moveString.toLowerCase().indexOf(move.toLowerCase()) !== -1) {
                return move;
            }
        }
    }
    
    function fuzzyMatch(inputBoard, boardArray) {
        let bestScore = 0;
        let bestBoard = boardArray[0] // Just to have a default
        for (let board of boardArray) {
            const score = board.split('')
                               .filter((e, i) => (e === inputBoard.charAt(i)))
                               .length
            if (score > bestScore) {
                bestScore = score;
                bestBoard = board;
            }
        }
        return bestBoard;
    }
    
    function findBestMove(chess, boardToMove) {
      moves = chess.moves();
      return moves[Math.floor(Math.random()*moves.length)];
    }
    
    function executePlayerMove(moveString) {
      const move = parseMove(moveString);
      if (move) {
        document.getElementById("chessInput").value = '';
        chess.move(move);
        console.log('Player move: ' + move);
        render(chess);
        setTimeout(function(){ makeBotMove(chess) }, 2000);
      }
    }
    
    function makeBotMove(chess) {
        const bestMove = findBestMove(chess);
        chess.move(bestMove);
        render(chess);
    }
    
    function render(chess) {
      const fenToUnicode = {
        'b': {
          'b': '&#9821;',
          'k': '&#9818;',
          'n': '&#9822;',
          'p': '&#9823;',
          'q': '&#9819;',
          'r': '&#9820;',
        },
        'w': {
          'b': '&#9815;',
          'k': '&#9812;',
          'n': '&#9816;',
          'p': '&#9817;',
          'q': '&#9813;',
          'r': '&#9814;',
        }
      }


      let board = '<table style=width:80vmin;height:80vmin>';
      for (let squareIndex of chess.SQUARES.keys()) {
          const square = chess.SQUARES[squareIndex];
          if((squareIndex)%8 === 0) {
            board += '<tr>';
          }
          const history = chess.history({ verbose: true });
          let color = chess.square_color(square) === 'dark'
                                                     ? 'lightgray'
                                                     : 'white'
          if (history.length > 0 && (square === history[history.length-1].from || square === history[history.length-1].to)) {
              color = 'yellow';
          }
          board += '<td bgcolor="' + color + '" style="overflow:hidden;height:8vmin;vertical-align:middle"><center><h1 style="font-size:5vmin;">' + (chess.get(square) ? fenToUnicode[chess.get(square).color][chess.get(square).type] : '') + '</h1></center></td>';
          if ((squareIndex+1)%8 === 0) {
            board += '</tr>'
          }
      }
      board += '</table>';
      document.getElementById("chessBoard").innerHTML = board;
      console.log(chess.ascii());
      console.log(chess)
    }
    /*
    while (!chess.game_over()) {
      var moves = chess.moves();
      console.log('moves', moves);
      var move = moves[Math.floor(Math.random() * moves.length)];
      chess.move(move);
      console.log(chess.ascii());
    }*/

</script>


<body onload="init()">
  <center>
      
      <div id="chessBoard">
      </div>
      <br>
      <div>
          <input style="background-color:lightyellow" id="chessInput" autocomplete="off" type="text" value onchange="executePlayerMove(value)">
          <!--<button onclick="executePlayerMove()">Execute move</button>-->
      </div>
  </center>
</body>
